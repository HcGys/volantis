<% 
  // 这里存放全局 CDN 资源控制变量 此处是硬编码
  // theme.cdn.addJS("search","search/"+theme.search.service,theme.search.js)  => theme.cdn.map.js.search
  // theme.cdn.addCSS("first","first",theme.cdn.set.css.first)  => theme.cdn.map.css.first

  theme.cdnCtrl={}
  if (theme.cdn.enable&&theme.cdn.prefix) {
    theme.cdnCtrl.prefix=theme.cdn.prefix.replace(/\/$/g, "")
  } else {
    theme.cdnCtrl.prefix="https://cdn.jsdelivr.net/npm/hexo-theme-volantis@"+ theme.info.theme_version +"/source"
  }
  theme.cdn.map={}
  theme.cdn.map.js={}
  theme.cdn.map.css={}
  theme.cdn.addJS=(name,source,force)=>{
    if(force){
      theme.cdn.map.js[name]=force
    }else{
      if(!source){
        source=name
      }
      source = source.replace(/^\//g, "")
      if (theme.cdn.enable) {
        let suffix=theme.cdn.prefix&&theme.cdn.prefix.match(/jsdelivr/g)?'.min.js':'.js'
        source= (suffix==".min.js")?source.replace(/\.min/g, ""):source
        theme.cdn.map.js[name]=theme.cdnCtrl.prefix + '/js/' + source + suffix
      } else {
        theme.cdn.map.js[name]=url_for('/js/')+ source + '.js'
      }
    }
    return theme.cdn.map.js[name]
  }
  theme.cdn.addCSS=(name,source,force)=>{
    if(force){
      theme.cdn.map.css[name]=force
    }else{
      if(!source){
        source=name
      }
      source = source.replace(/^\//g, "")
      if (theme.cdn.enable&&theme.cdn.prefix) {
        let suffix=theme.cdn.prefix.match(/jsdelivr/g)?'.min.css':'.css'
        source= (suffix==".min.js")?source.replace(/\.min/g, ""):source
        theme.cdn.map.css[name]=theme.cdnCtrl.prefix + '/css/' + source + suffix
      } else {
        theme.cdn.map.css[name]=url_for('/css/')+ source + '.css'
      }
    }
    return theme.cdn.map.css[name]
  }
  dfs = (n,path) => {
    for (const key in n) {
      const element = n[key];
      if(element && typeof element !="string"){
        dfs(element,path.concat(key))
      }else{
        let op=path.concat(key)
        let source=""
        for (let index = 1; index < op.length; index++) {
          const element = op[index];
          source+=element
          if (index!=op.length-1) {
            source+="/"
          }
        }
        if(op[0]=="js"){
          theme.cdn.addJS(op[op.length-1],source,element)
        }
        if(op[0]=="css"){
          theme.cdn.addCSS(op[op.length-1],source,element)
        }
      }
    }
  }
  dfs(theme.cdn.set,[])
%>



